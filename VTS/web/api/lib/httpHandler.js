var util=require("util"),global=require("../../admin/common").Globalize,strings=global.instance.getResource().errorMessages,apiServer=require("./apiServer"),buildError=require("./common").buildError,errorCodesBase=-20200,errorCodes={error_unknown:errorCodesBase-1,error_invalid_command:errorCodesBase-2,error_client_version_too_low:errorCodesBase-3,error_api_access_disabled:errorCodesBase-4,error_not_authorized:errorCodesBase-5};function errorFilter(b,g){return function(d,e){d?b(d,e):g(d,e)}}
function HttpHandler(b){null==b&&(b=apiServer.getInstance());if(!(this instanceof HttpHandler))return new HttpHandler(b);this.sps=b}HttpHandler.prototype.enableAccess=function(b){this.apiAccessDisabled=!b};HttpHandler.prototype.authorize=function(b){this.apiAccessAuthorized=b};
HttpHandler.prototype.handle=function(){var b=this.sps,g=this;return function(d,e){function h(a,c){var b={data:void 0===c?null:c,status:{error:null,code:0}};a&&(b={data:null,status:{error:a.message,code:a.code||errorCodes.error_unknown}});b=JSON.stringify(b);a&&a.code==errorCodes.error_not_authorized?e.writeHead(403,{"Content-Type":"application/json"}):e.writeHead(200,{"Content-Type":"application/json"});e.write(b);e.end();logger.info("return: "+b)}var k=d.body;try{var f=configure.admin.role.administrator,
q=configure.admin.role.user,l=!1,i;if("None"==configure.admin.authentication||0==f.length&&0==q.length||"Basic"==configure.admin.authentication&&!1==configure.admin.requireBasicAuthForAPI)l=!0;else{if("Basic"==configure.admin.authentication)i=d.user;else if("NTLM"==configure.admin.authentication&&void 0!=d.ntlm){var m=d.ntlm.UserName.split("@");if(1<m.length)var n=m[0],p=m.slice(1).join("@");else n=d.ntlm.UserName,p=d.ntlm.DomainName;i=p+"\\"+n}else i=null;for(var r in f)null!=i&&i.toLowerCase()==
f[r].toLowerCase()&&(l=!0)}g.apiAccessAuthorized=l;f=k;k.request&&(f=JSON.parse(k.request));logger.info("run cmd:"+JSON.stringify(f));var c=f,j={add:function(a){b.add(c.data["new"],c.data.option,a)},get:function(a){b.get(c.data.columns,c.data.index,a)},retrieve:function(a){b.retrieve(c.data.columns,a)},rotate:function(a){b.rotate(c.data.columns,c.data.option,a)},update:function(a){b.update(c.data["new"],c.data.index,a)},update_ifequals:function(a){b.update_ifequals(c.data["new"],c.data.condition,
c.data.index,a)},clear:function(a){b.clear(c.data.columns,c.data.index,a)},inc:function(a){b.inc(c.data.column,c.data.index,c.data.value,a)},createColumn:function(a){b.createColumn(c.data.columns,a)},clearColumn:function(a){b.clearColumn(c.data.columns,a)},ensureIndex:function(a){b.ensureIndex(c.data.columns,a)},dropIndex:function(a){b.dropIndex(c.data.columns,a)},getColumnSize:function(a){b.getColumnSize(c.data.column,a)},queryMessage:function(a){b.queryMessage(c.data.columns,c.data.value,a)},updateAll_ifequals:function(a){b.updateAll_ifequals(c.data.columns,
c.data.oldValue,c.data.newValue,a)},drop:function(a){b.drop(a)},initialize:function(a){b.initialize(a)},handshake:function(){e.write(JSON.stringify({data:{version:"1.1"},status:{error:"OK",code:0}}));e.end()}}[c.cmd];g.apiAccessDisabled?h(buildError(errorCodes.error_api_access_disabled,strings.error_api_access_disabled||"API access not enabled.")):j?g.apiAccessAuthorized||j.name.includes("get")||j.name.includes("initialize")||j.name.includes("handshake")?j(h):h(buildError(errorCodes.error_not_authorized,
strings.error_not_authorized||"Not authorized.")):h(buildError(errorCodes.error_invalid_command,strings.error_invalid_command||"invalid command:%s",JSON.stringify(c)))}catch(s){h(buildError(errorCodes.error_unknown,s))}}};exports.HttpHandler=HttpHandler;
