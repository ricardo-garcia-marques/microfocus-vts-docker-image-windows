var common=require("../common"),leveldb=require("leveldown"),path=require("path"),fs=require("fs"),util=require("util"),events=require("events"),errorFilter=common.errorFilter,MultipleAsyncWaiter=common.MultipleAsyncWaiter;function Db(a,b){b=b||{};void 0===b.createIfMissing&&(b.createIfMissing=!0);this.opened=!1;this.options=b;this.name=a;this.db=leveldb(this.name)}
Db.prototype.open=function(a){var b=this;this.opened?b.opened=!0:this.db.open(this.options,common.errorFilter(a,function(c){c?(logger.error("db cannot be opened"),a(null,null)):a(null,b)}))};Db.prototype.destroy=function(a){this.db.destroy(this.name,a)};Db.prototype.getCollection=function(a){return new Collection(this,a)};Db.prototype.getIndex=function(){return new Index};Db.prototype.putMultiple=function(a,b){for(var c=this.db.batch(),d=a.length,e=0;e<d;++e){var f=a[e];c.put(f.key,f.value)}c.write(b)};
Db.prototype.forPrefix=function(a,b,c,d){b.keyAsBuffer=!1;b.valueAsBuffer=!0;var e=this.db.iterator(b),a=a.toString("binary"),f=function(b,g,i){if(b)return c(b);g&&i&&g.toString("binary").substring(0,a.length)===a?(c(null,g.toString(),i.toString()),e.next(f)):e.end(d)};e.seek(a);e.next(f)};
Db.prototype.forPrefixDelete=function(a,b,c,d){var e=this,f=0,h=new MultipleAsyncWaiter(d),g=e.db.batch();e.forPrefix(a,c,function(a,c){g.del(c);++f>=b&&(h.wait(),f=0,g.write(h.done.bind(h)),g=e.db.batch())},function(){f?(h.wait(),g.write(h.done.bind(h))):h.done()})};Db.prototype.forRange=function(a,b,c,d,e){if(a>=b)e&&e();else{c.keyAsBuffer=!1;c.valueAsBuffer=!0;var f=this.db.iterator(c);f.seek(a);f.next(function g(a,c,j){c&&c<b?(d(null,c.toString(),j.toString()),f.next(g)):f.end(function(){e()})})}};
Db.prototype.getMeta=function(a,b){this.db.get(a,b)};Db.prototype.putMeta=function(a,b,c){this.db.put(a,b,c)};Db.prototype.deleteMeta=function(a,b){this.db.del(a,b)};Db.prototype.store=function(a,b){var c=this.db.batch();a(null,c);c.write(b)};Db.prototype.asyncStore=function(a,b){var c=this.db.batch();a(null,c,function(){c.write(b)})};var defaultQueryOptions={keyAsBuffer:0,valueAsBuffer:0},defaultBatchSize=1E3;function Collection(a,b){this.db=a;this.info=b;this.id=b.id}util.inherits(Collection,events.EventEmitter);
Collection.prototype.getKeyPrefix=function(){return this.id+":"};Collection.prototype.getGlobalKey=function(a){if(0>a)return a=(9007199254740992+a).toString(16),this.id+":0"+"00000000000000".slice(0,14-a.length)+a;a=a.toString(16);return this.id+":1"+"00000000000000".slice(0,14-a.length)+a};Collection.prototype.getIndexFromGlobalKey=function(a){a=a.split(":");a=a[a.length-1];return 49==a.charCodeAt(0)?parseInt(a.substring(1),16):parseInt(a.substring(1),16)-9007199254740992};
Collection.prototype.get=function(a,b){this.db.db.get(this.getGlobalKey(a),{asBuffer:!1},function(a,d){b(a,d)})};Collection.prototype.getRange=function(a,b,c){var d=[];if(a>=b)return c(null,d);var e=null,f=this.getGlobalKey(b-1);this.db.forRange(this.getGlobalKey(a),this.getGlobalKey(b),defaultQueryOptions,function(a,b,c){a?e=a:d.push(c);if(f===b)return!0},function(){c(e,d)})};
Collection.prototype.forRange=function(a,b,c,d){var e=this;this.db.forRange(this.getGlobalKey(a),this.getGlobalKey(b),defaultQueryOptions,function(a,b,d){return c(a,e.getIndexFromGlobalKey(b),d)},d)};Collection.prototype.batchAdd=function(a,b,c){a.put(this.getGlobalKey(b),c);this.listeners("add").length&&this.emit("add",a,b,c)};
Collection.prototype.batchUpdate=function(a,b,c,d,e){a.put(this.getGlobalKey(b),d);this.listeners("update").length?e?(e=new MultipleAsyncWaiter(e),this.emit("update",a,b,c,d,e),e.done()):this.emit("update",a,b,c,d):e&&e()};Collection.prototype.batchAddRange=function(a,b,c){for(var d=c.length,e=this.listeners("add").length,f=0;f<d;++f){var h=b+f,g=c[f];a.put(this.getGlobalKey(h),g);e&&this.emit("add",a,h,g)}};
Collection.prototype.batchFillNewRange=function(a,b,c,d){for(var e=this.listeners("add").length;b<c;)a.put(this.getGlobalKey(b),d),e&&this.emit("add",a,b,d),++b};Collection.prototype.batchDelete=function(a,b,c,d){a.del(this.getGlobalKey(b));this.listeners("del").length?d?(d=new MultipleAsyncWaiter(d),this.emit("del",a,b,c,d),d.done()):this.emit("del",a,b,c):d&&d()};
Collection.prototype.batchDeleteRange=function(a,b,c,d){for(var d=new MultipleAsyncWaiter(d),e=this.listeners("del").length;b<c;++b)a.del(this.getGlobalKey(b)),e&&this.emit("del",a,b,void 0,d);d.done()};Collection.prototype.batchClean=function(a,b){var c=!1,d=this,e=this.listeners("del").length;this.db.forPrefix(this.getKeyPrefix(),defaultQueryOptions,function(b,h,g){a.del(h);e&&d.emit("del",a,d.getIndexFromGlobalKey(h),g);c=!0},function(a,d){b(a,c,d)})};
Collection.prototype.clean=function(a){var b=this.db.db.batch();this.batchClean(b,function(c,d){d?b.write(a):a()})};function Index(){}Index.prototype.getIndexKeyPrefix=function(a){return"i"+a+":"};Index.prototype.getIndexKeyForValue=function(a,b){return this.getIndexKeyPrefix(a)+escape(b)};Index.prototype.getIndexKey=function(a,b,c){return this.getIndexKeyForValue(a,c)+":"+b};Index.prototype.getIndexValue=function(){return null};
Index.prototype.getFirstKeyOfValue=function(a,b,c,d){var e=null;a.forPrefix(this.getIndexKeyForValue(b,c)+":",defaultQueryOptions,function(a,b){var c=b.split(":");e=c[c.length-1];return!0},function(a){d(a,e)})};Index.prototype.getKeysOfValue=function(a,b,c,d,e){var f=null,b=this.getIndexKeyForValue(b,c)+":";a.forPrefix(b,defaultQueryOptions,function(a,b){var c=b.split(":");f=c[c.length-1];return d(a,f)},function(a){e(a)})};
Index.prototype.deleteIndexForId=function(a,b,c){a.forPrefixDelete(this.getIndexKeyPrefix(b),defaultBatchSize,defaultQueryOptions,c)};Index.prototype.batchDeleteIndex=function(a,b,c,d){a.del(this.getIndexKey(b,c,d))};Index.prototype.batchAddIndex=function(a,b,c,d){a.put(this.getIndexKey(b,c,d),"")};Index.prototype.batchUpdateIndex=function(a,b,c,d,e){a.del(this.getIndexKey(b,c,d));a.put(this.getIndexKey(b,c,e),"")};module.exports.Db=Db;
