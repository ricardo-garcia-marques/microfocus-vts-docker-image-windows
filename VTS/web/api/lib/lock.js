var common=require("./common"),Mutex=common.Mutex,ReaderWriterLock=common.ReaderWriterLock,noop=common.noop,leftInsertPos=common.leftInsertPos,insertToSortedArray=common.insertToSortedArray,removeFromSortedArray=common.removeFromSortedArray,isValidNumber=common.isValidNumber;function CallTracer(){void 0===CallTracer.high&&(CallTracer.high=0);CallTracer.high++;this.id=CallTracer.high}CallTracer.prototype.callOnce=function(a){this[a]||(this[a]=0);++this[a]};function NoLock(){}
NoLock.prototype.acquireSharedTableLock=function(a){a()};NoLock.prototype.releaseSharedTableLock=function(){};NoLock.prototype.acquireTableLock=function(a){a()};NoLock.prototype.releaseTableLock=function(){};NoLock.prototype.acquireSingleLock=function(a,b){b()};NoLock.prototype.releaseSingleLock=function(){};NoLock.prototype.acquireRangeLock=function(a,b,d){d()};NoLock.prototype.releaseRangeLock=function(){};module.exports.NoLock=NoLock;
function RowLock(){this.sortedSingleLockedIndexes=[];this.sortedRangeStarts=[];this.singleLocks={};this.rangeLocks={};this.tableLock=new ReaderWriterLock;this.trace=new CallTracer}RowLock.prototype.acquireSharedTableLock=function(a){this.tableLock.acquireReaderLock(a)};RowLock.prototype.releaseSharedTableLock=function(){this.tableLock.releaseReaderLock()};RowLock.prototype.acquireTableLock=function(a){this.tableLock.acquireWriterLock(a)};RowLock.prototype.releaseTableLock=function(){this.tableLock.releaseWriterLock()};
RowLock.prototype.acquireSingleLock=function(a,b){b.called=0;var d=this.singleLocks[a];if(!d){d=new Mutex;this.singleLocks[a]=d;insertToSortedArray(this.sortedSingleLockedIndexes,a);var c=leftInsertPos(a,this.sortedRangeStarts,0,this.sortedRangeStarts.length),c=this.sortedRangeStarts[c];if(isValidNumber(c)&&(c=this.rangeLocks[c])&&c.start<=a&&c.end>=a)c.waits.push(a),++c.waitcount,d.wait(noop)}d.wait(b)};
RowLock.prototype.releaseSingleLock=function(a){var b=this.singleLocks[a];b.signal();b.state&&(delete this.singleLocks[a],removeFromSortedArray(this.sortedSingleLockedIndexes,a))};
RowLock.prototype.acquireRangeLock=function(a,b,d){var c=this.sortedSingleLockedIndexes.length,e={waitcount:0,start:a,end:b,waits:[],callback:function(){0===--e.waitcount&&d()}};this.rangeLocks[e.start]=e;insertToSortedArray(this.sortedRangeStarts,a);for(a=leftInsertPos(a,this.sortedSingleLockedIndexes,0,c);a<c;++a){var f=this.sortedSingleLockedIndexes[a];if(!isValidNumber(f)||f>b)break;else++e.waitcount,e.waits.push(f)}c=e.waits.length;if(0<c)for(b=0;b<c;++b)this.singleLocks[e.waits[b]].wait(e.callback);
else d()};RowLock.prototype.releaseRangeLock=function(a){var b=this.rangeLocks[a],d=b.waits.length;delete this.rangeLocks[a];removeFromSortedArray(this.sortedRangeStarts,a);for(a=0;a<d;++a)this.singleLocks[b.waits[a]].signal()};module.exports.RowLock=RowLock;
