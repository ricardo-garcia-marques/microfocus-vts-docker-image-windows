var connect=require("connect"),url=require("url"),fs=require("fs"),path=require("path"),http=require("http"),querystring=require("querystring"),https=require("https"),data=require("./data"),common=require("./common"),root=__dirname+"/Web",notifier=require("./notifier"),api=require("../api"),InstanceManager=require("./instmgr").InstanceManager,ntlm=require("express-ntlm"),uploadFolder=root+"/file";fs.existsSync(uploadFolder)||fs.mkdirSync(uploadFolder);var users=null;
function auth(a,d,b){var c=b.connection.address();if(c&&"127.0.0.1"===c.address)for(key in b.headers)if(0===key.search(/^user-agent$/i)&&"VTSCMD"===b.headers[key])return!0;if(null==users)for(i in users={},tmp=configure.admin.users,tmp)users[tmp[i].user.toLowerCase()]=tmp[i].password;a=a.toLowerCase();return d==users[a]}
function preprocess(a,d){a.cookies=common.parseCookie(a.headers.cookie);var b=d.search;if(b){var c=b.lastIndexOf("?"),b=b.substr(0<=c?c+1:0);query=querystring.parse(b);a.query=query}}function AdminServer(a){this.options=a}AdminServer.instance=null;AdminServer.prototype.startApiServerIfNeeded=function(){var a=this;data.getApiServerConfig(null,function(d,b){a.started=!1;d?logger.info(d):(a.port=b.port,InstanceManager.Instance.enableApiAccess(b.start),b.start&&api.getHttpServer().start(b.port))})};
AdminServer.prototype.initChain1=function(a){this.app=a;a.use(connect.bodyParser({uploadDir:uploadFolder,keepExtensions:!0}))};
AdminServer.prototype.initChain2=function(a){var d=this.adminHandler=data.getHandler(this.options);"Basic"==configure.admin.authentication&&a.use(function(a,c,d){connect.basicAuth(function(c,d){return auth(c,d,a)})(a,c,d)});a.use(function(a,c,f){var e=url.parse(a.url);if(0==e.pathname.indexOf("/data"))preprocess(a,e),d.handle(e,a,c);else if("/"==e.pathname)preprocess(a,e),a=a.context(),c.setHeader("Content-Type","text/html; charset=UTF-8"),a.processHtml(c,"index.tpl.html");else return f()});a.use(connect["static"](root))};
AdminServer.prototype.initServer=function(){var a=connect();a.use(connect.logger("dev"));configure.admin.useSSL&&configure.admin.requestClientCert&&a.use(function(a,b,c){if(a.client.authorized)return c();logger.error("no valid certificate for server verification");b.statusCode=495;b.end("no valid client certificate!")});"NTLM"==configure.admin.authentication&&a.use(ntlm({domain:configure.admin.domain,domaincontroller:configure.admin.domaincontroller}));this.initChain1(a);this.initChain2(a);this.createHttpServer(a)};
AdminServer.prototype.createHttpServer=function(){this.server=null;if(!0==configure.admin.useSSL){var a={key:fs.readFileSync(configure.admin.privateKey),cert:fs.readFileSync(configure.admin.certificate),secureProtocol:{auto:"SSLv23_method","tls1.0":"TLSv1_method","tls1.1":"TLSv1_1_method","tls1.2":"TLSv1_2_method"}[configure.admin.tlsVersion],ciphers:configure.admin.ciphers,passphrase:configure.admin.passphrase};configure.admin.requestClientCert&&(a.requestCert=!0,a.rejectUnauthorized=!1,a.ca=[fs.readFileSync(configure.admin.ca)]);
this.server=https.createServer(a,this.app)}else this.server=http.createServer(this.app)};AdminServer.prototype.start=function(){var a=this.server.listen(this.options.port);notifier.attach(a);this.startApiServerIfNeeded()};AdminServer.createInstance=function(a){return AdminServer.instance=new AdminServer(a)};exports.getInstance=function(){return AdminServer.instance};exports.createInstance=AdminServer.createInstance;exports.startServer=function(a){a=AdminServer.createInstance(a);a.initServer();a.start()};
