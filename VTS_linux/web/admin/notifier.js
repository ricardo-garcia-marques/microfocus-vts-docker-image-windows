var engine=require("engine.io"),url=require("url"),NotifyMethods=Object.freeze({data_change:"data_change",config_change:"config_change"}),channelManager=function(){var b=[],a={register:function(a){logger.info("client registered");a.count=0;b.push(a)}};Object.defineProperty(a,"count",{get:function(){return b.length}});a.remove=function(){logger.info("client removed");for(var a=0;a<b.length;a++)if(b[a]){b.splice(a,1);break}};a.notifyAll=function(a,f){for(var c=0;c<b.length;c++){var d=b[c];d.port==f&&
(d.send(JSON.stringify(a)),d.count=0)}};return Object.create(a)}(),changeMonitor=function(){var b=(new Date).getTime(),a=!1,e=0,f={lastChangeTime:function(){return b},notify:function(b){channelManager.notifyAll({method:NotifyMethods.data_change,data:{count:e}},b);e=0;a=!1},notifyConfig:function(a){channelManager.notifyAll({method:NotifyMethods.config_change,data:a})},changed:function(c,d){c=isNaN(c)?1:c;e+=parseInt(c);b=(new Date).getTime();a||(a=!0,setTimeout(function(){f.notify(d)},500))}};return Object.create(f)}();
function attach(b){engine.attach(b,{path:"/engine.io"}).on("connection",function(a){logger.info("client connected, id:"+a.id);var b=-1;void 0!=a.request.headers.referer&&(b=a.request.headers.referer.indexOf("/port="));a.port=-1!=b?a.request.headers.referer.substring(b+6):configure.defaultApiPort;channelManager.register(a);a.on("message",function(b){a.send("echo "+b)});a.on("close",function(){channelManager.remove(a)})})}exports.changeMonitor=changeMonitor;exports.attach=attach;
